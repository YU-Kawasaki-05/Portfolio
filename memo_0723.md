# 2025-07-23 作業メモ

## 現状サマリ
1. **目的**
   - `HeaderNav.test.tsx` / `WorkTable.test.tsx` / `hero3d.test.tsx` に残っている `ReferenceError: Cannot access 'xxx' before initialization` を解消し、`pnpm test` がすべてパスする状態にする。
2. **いまの失敗ポイント**
   | ファイル | 原因 | 備考 |
   |---------|------|------|
   | HeaderNav.test.tsx | `mockUsePathname` / `mockUseMotionPreference` を外部変数経由で参照 → TDZ | 型 `MotionContextType` の不足プロパティも要対応 |
   | WorkTable.test.tsx | `mockGetAllWorks` を外部変数経由で参照 → TDZ | factory モックは作成済だが TDZ のまま |
   | hero3d.test.tsx | `mockUseMotionPreference` を外部変数経由で参照 → TDZ | 同上 |

3. **これまでの対応**
   - テスト3件を *hoist-safe* 化する方針で書き換えを試行。
   - しかし依然として TDZ エラーと型エラーが残存。

## 根本解決方針（Vitest 推奨）
1. **モックは factory 内で完結** させ、外部変数を介さない。
   ```ts
   vi.mock('next/navigation', () => ({
     usePathname: vi.fn(() => '/')
   }));
   ```
2. テスト本体で **`vi.mocked(importedFn)` を取得して挙動を変更**。
   ```ts
   import { usePathname } from 'next/navigation';
   const mockUsePathname = vi.mocked(usePathname);

   beforeEach(() => {
     mockUsePathname.mockReturnValue('/');
   });
   ```
3. `MotionContextType` を満たすよう、`prefersReducedMotion` と `toggleMotion` を返す:
   ```ts
   useMotionPreference: vi.fn(() => ({
     isMotionEnabled: true,
     prefersReducedMotion: false,
     toggleMotion: vi.fn()
   }))
   ```
4. **import 順序**: モック → テスト対象コンポーネント (`import HeaderNav from './HeaderNav'`) の順に配置。

## 次にやる作業手順
1. `HeaderNav.test.tsx` を上記パターンで全面置換。
2. 同じ手順で `WorkTable.test.tsx` (`../data` を spyOn) と `hero3d.test.tsx` を置換。
3. `pnpm test` 実行 → 通過確認。
4. 通過後 `tasks.md` の 919–91C を **☑** へ更新し、5D9 も **☑** に変更。

## 工数目安
- HeaderNav 修正: ~10 分
- WorkTable 修正: ~10 分
- hero3d 修正: ~5 分
- 再テスト: ~5 分
- 合計 30 分程度

---
**次にこの作業を引き継ぐ AI へ**: 上記方針に沿って 3 ファイルを順に書き換え、`pnpm test` が通るまで実行してください。
